<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d0d0d"/>
  <title>《Crypto简史》 · 手机阅读书壳</title>
  <style>
    :root { --cshell-accent:#7aa2ff; --cshell-accent2:#9a7aff; --cshell-fg:#eaeaea; --cshell-muted:#9aa3b2; --cshell-bg:#0b0c12; --cshell-card:#12131a; --cshell-border:#1c1e26; }
    #cshell-app, #cshell-app * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:#000; }
    #cshell-app { position: fixed; inset: 0; background: var(--cshell-bg); color: var(--cshell-fg);
      font-family: -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Hiragino Sans GB","Segoe UI",Roboto,Arial,"Noto Sans CJK SC",sans-serif; overflow: hidden; }

    /* top reading progress (per chapter) */
    #cshell-progress { position: fixed; left:0; right:0; top:0; height: 3px; z-index:6; background: rgba(255,255,255,.06); }
    #cshell-progress.hidden { display:none; }
    #cshell-progress-bar { height:100%; width:0%; background: linear-gradient(90deg, var(--cshell-accent), var(--cshell-accent2)); transition: width .15s ease; }

    /* toc + bookmarks */
    #cshell-toc { position:absolute; inset:0; padding: env(safe-area-inset-top) 12px calc(72px + env(safe-area-inset-bottom)) 12px; overflow:auto; }
    .cshell-tabs { display:flex; gap:10px; position:sticky; top: max(8px, env(safe-area-inset-top)); z-index:2; background: linear-gradient(180deg, rgba(11,12,18,.98), rgba(11,12,18,.8)); padding:8px 6px; border-radius:12px; border:1px solid var(--cshell-border); backdrop-filter: blur(6px); }
    .cshell-tab { flex:1; text-align:center; padding:10px 0; border-radius:10px; color: var(--cshell-muted); border:1px solid var(--cshell-border); background: var(--cshell-card); }
    .cshell-tab[aria-selected="true"] { color:#fff; background: linear-gradient(135deg, var(--cshell-card), rgba(122,162,255,.12)); border-color: rgba(122,162,255,.3); font-weight:600; }
    .cshell-section { margin-top:12px; }
    .cshell-part { color:var(--cshell-muted); font-size:12px; margin:12px 8px 6px; }
    .cshell-list { list-style:none; margin:0; padding:0; display:grid; grid-template-columns: 1fr; gap:10px; }
    .cshell-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 14px; border:1px solid var(--cshell-border); border-radius:12px; background: var(--cshell-card); }
    .cshell-item a { color:#fff; text-decoration:none; font-weight:600; }

    .cshell-resume { margin:10px 0 2px; padding:10px 12px; border:1px dashed rgba(122,162,255,.35); border-radius:10px; color:#d9e2ff; background: rgba(122,162,255,.08); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .cshell-resume button { background: linear-gradient(135deg, var(--cshell-accent), var(--cshell-accent2)); color:#fff; border:none; padding:8px 12px; border-radius:999px; }

    .cshell-bmk { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border:1px solid var(--cshell-border); border-radius:12px; background: var(--cshell-card); }
    .cshell-bmk .meta { color:var(--cshell-muted); font-size:12px; }
    .cshell-bmk .act { display:flex; gap:8px; }
    .cshell-bmk .act button { border:1px solid var(--cshell-border); background:transparent; color:#fff; padding:6px 10px; border-radius:8px; }

    #cshell-reader { position:absolute; inset:0; }
    #cshell-frame { position:absolute; inset:0; width:100vw; height:100vh; border:none; background:#fff; }

    #cshell-nav { position: fixed; left: 0; right: 0; bottom: 10px; display:flex; justify-content:center; pointer-events:none; z-index: 5; }
    .cshell-nav-wrap { pointer-events:auto; display:flex; gap:10px; padding:8px; border-radius:16px; background: rgba(9,10,16,.8); border:1px solid var(--cshell-border); backdrop-filter: blur(10px); }
    .cshell-btn { position:relative; appearance:none; border:none; border-radius:12px; padding:12px 14px; min-width:88px; overflow:hidden; background: linear-gradient(135deg, rgba(122,162,255,.16), rgba(154,122,255,.16)); color:#fff; font-weight:700; }
    .cshell-btn[disabled] { opacity:.4; }
    .cshell-btn--primary { background: linear-gradient(135deg, var(--cshell-accent), var(--cshell-accent2)); }
    .cshell-btn .cshell-btn-bar { position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(135deg, rgba(255,255,255,.25), rgba(255,255,255,.15)); pointer-events:none; }
    .cshell-btn .cshell-btn-label { position:relative; z-index:1; }

    .cshell-hidden { display:none !important; }

    #cshell-bookmark { position: fixed; top: max(8px, calc(env(safe-area-inset-top) + 8px)); right: 10px; z-index:6; background: #e11d48; color:#fff; border:none; border-radius:12px; padding:10px 12px; box-shadow: 0 8px 24px rgba(225,29,72,.3); }

    .cshell-toast { position: fixed; left:50%; transform: translateX(-50%); bottom: calc(64px + env(safe-area-inset-bottom)); background: rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:10px; z-index:7; opacity:0; transition:.25s opacity ease; }
    .cshell-toast.show { opacity:1; }
  </style>
</head>
<body>
  <div id="cshell-app" aria-live="polite">
    <div id="cshell-progress" class="hidden" aria-hidden="true"><div id="cshell-progress-bar"></div></div>

    <section id="cshell-toc" role="navigation" aria-label="目录">
      <div class="cshell-tabs" role="tablist">
        <button id="cshell-tab-toc" class="cshell-tab" role="tab" aria-selected="true">目录</button>
        <button id="cshell-tab-bmk" class="cshell-tab" role="tab" aria-selected="false">书签</button>
      </div>

      <div id="cshell-resume" class="cshell-resume cshell-hidden">
        <div>上次读到：<span id="cshell-resume-title"></span></div>
        <button id="cshell-resume-btn">继续阅读</button>
      </div>

      <div id="cshell-toc-list" class="cshell-section">
        <div class="cshell-part">第一编（1970s–2008）观念与技术的源流</div>
        <ul id="cshell-chapter-list" class="cshell-list"></ul>
      </div>

      <div id="cshell-bmk-list" class="cshell-section cshell-hidden">
        <div class="cshell-part">我的书签</div>
        <div id="cshell-bmk-empty" class="cshell-bmk">暂无书签，在阅读时点右上角红丝带即可添加。</div>
        <ul id="cshell-bmk-items" class="cshell-list"></ul>
      </div>
    </section>

    <section id="cshell-reader" class="cshell-hidden" aria-label="阅读器">
      <iframe id="cshell-frame" title="章节阅读器" referrerpolicy="no-referrer" loading="eager"></iframe>
    </section>

    <div id="cshell-nav" class="cshell-hidden">
      <div class="cshell-nav-wrap">
        <button id="cshell-prev" class="cshell-btn" aria-label="上一页"><span class="cshell-btn-label">上一页</span></button>
        <button id="cshell-toc-btn" class="cshell-btn cshell-btn--primary" aria-label="目录（页数进度）">
          <div class="cshell-btn-bar" id="cshell-btn-progress" aria-hidden="true"></div>
          <span class="cshell-btn-label">目录</span>
        </button>
        <button id="cshell-next" class="cshell-btn" aria-label="下一页"><span class="cshell-btn-label">下一页</span></button>
      </div>
    </div>

    <button id="cshell-bookmark" class="cshell-hidden" aria-label="添加书签">🔖 书签</button>

    <div id="cshell-toast" class="cshell-toast" role="status" aria-live="polite">已添加到书签</div>
  </div>

  <script>
  (function(){
    'use strict';
    const QS = (sel, root=document) => root.querySelector(sel);
    const QSA = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const $toc = QS('#cshell-toc');
    const $reader = QS('#cshell-reader');
    const $frame = QS('#cshell-frame');
    const $nav = QS('#cshell-nav');
    const $prev = QS('#cshell-prev');
    const $next = QS('#cshell-next');
    const $tocBtn = QS('#cshell-toc-btn');
    const $bookmarkBtn = QS('#cshell-bookmark');
    const $toast = QS('#cshell-toast');
    const $resumeWrap = QS('#cshell-resume');
    const $resumeTitle = QS('#cshell-resume-title');
    const $resumeBtn = QS('#cshell-resume-btn');
    const $chapterList = QS('#cshell-chapter-list');
    const $bmkListWrap = QS('#cshell-bmk-list');
    const $bmkEmpty = QS('#cshell-bmk-empty');
    const $bmkItems = QS('#cshell-bmk-items');
    const $tabToc = QS('#cshell-tab-toc');
    const $tabBmk = QS('#cshell-tab-bmk');
    const $progress = QS('#cshell-progress');
    const $progressBar = QS('#cshell-progress-bar');
    const $btnProgress = QS('#cshell-btn-progress');

    const LS = window.localStorage;
    const KEY_LAST = 'cshell:last';
    const KEY_BMK = 'cshell:bookmarks';

    let CHAPTERS = [];
    let currentIndex = -1;
    let scrollTimer = null;

    const ENABLE_SEGMENTED_RESTORE = true;

    function show(el){ el.classList.remove('cshell-hidden'); }
    function hide(el){ el.classList.add('cshell-hidden'); }
    function toast(msg='已添加到书签'){ $toast.textContent = msg; $toast.classList.add('show'); setTimeout(()=> $toast.classList.remove('show'), 1400); }
    function loadJSON(url){ return fetch(url).then(r=>r.json()); }
    function getLast(){ try { return JSON.parse(LS.getItem(KEY_LAST) || 'null'); } catch(e){ return null; } }
    function setLast(obj){ try { LS.setItem(KEY_LAST, JSON.stringify(obj)); } catch(e){} }
    function getBmk(){ try { return JSON.parse(LS.getItem(KEY_BMK) || '[]'); } catch(e){ return []; } }
    function setBmk(list){ try { LS.setItem(KEY_BMK, JSON.stringify(list)); } catch(e){} }
    function ratioToPx(doc, ratio){ const el = doc.scrollingElement || doc.documentElement || doc.body; const max = el.scrollHeight - el.clientHeight; return Math.max(0, Math.min(max, Math.round(max * ratio))); }
    function pxToRatio(doc){ const el = doc.scrollingElement || doc.documentElement || doc.body; const max = el.scrollHeight - el.clientHeight || 1; return Math.max(0, Math.min(1, el.scrollTop / max)); }
    function setScrollProgress(r){ if ($progressBar) $progressBar.style.width = Math.round(r*100) + '%'; }
    function setPageProgress(index){ if (!CHAPTERS.length) return; const r = Math.max(0, Math.min(1, (index+1)/CHAPTERS.length)); if ($btnProgress) $btnProgress.style.width = Math.round(r*100) + '%'; $tocBtn.setAttribute('aria-label', `目录（${index+1}/${CHAPTERS.length}）`); }
    function updateResumeCard(){ const last = getLast(); if (last && CHAPTERS[last.index]){ $resumeTitle.textContent = CHAPTERS[last.index].title.replace(/^第一编_/,'') + (typeof last.scrollRatio==='number' ? ` · ${Math.round(last.scrollRatio*100)}%` : ''); show($resumeWrap); } else { hide($resumeWrap); } }
    function snapshotProgress(){ try { const doc = $frame.contentDocument; if (!doc) return; const ratio = pxToRatio(doc); const cur = getLast() || {}; if (typeof ratio === 'number' && cur && cur.index === currentIndex){ cur.scrollRatio = ratio; setLast(cur); } } catch(e){} }

    // Promise-based robust restore
    function robustRestore(doc, desiredRatio){
      return new Promise((resolve) => {
        try{
          const el = doc.scrollingElement || doc.documentElement || doc.body;
          let attempts = 50; // up to ~2.5s
          let lastH = 0;
          function tick(){
            try{
              const H = el.scrollHeight;
              const targetPx = ratioToPx(doc, desiredRatio);
              el.scrollTop = targetPx;
              const near = Math.abs(el.scrollTop - targetPx) <= 3;
              const heightStable = Math.abs(H - lastH) <= 2;
              setScrollProgress(pxToRatio(doc));
              if (near && heightStable){ resolve(true); return; }
              lastH = H;
              if (attempts-- > 0){ setTimeout(tick, 50); } else { resolve(false); }
            }catch(e){ resolve(false); }
          }
          try {
            const imgs = doc.images || [];
            for (const im of imgs){ if (!im.complete){ im.addEventListener('load', ()=> setTimeout(tick, 30), {once:true}); } }
            if (doc.fonts && doc.fonts.ready){ doc.fonts.ready.then(()=> setTimeout(tick, 30)); }
          } catch(e){}
          setTimeout(tick, 30);
        }catch(e){ resolve(false); }
      });
    }

    // staged ratios for segmented restore
    function stagedRatios(t){
      t = Math.max(0, Math.min(1, t));
      const stages = [];
      if (t < 0.15) return [t];
      // Always warm up layout a bit to reduce jumps
      stages.push(0.2);
      if (t > 0.35) stages.push(0.5);
      if (t > 0.70) stages.push(0.8);
      if (t > 0.90) stages.push(0.95);
      stages.push(t);
      // remove duplicates and ensure ascending
      const uniq = [...new Set(stages)].sort((a,b)=>a-b);
      return uniq;
    }

    async function segmentedRestore(doc, t){
      if (!ENABLE_SEGMENTED_RESTORE) return robustRestore(doc, t);
      const seq = stagedRatios(t);
      for (const r of seq){
        await robustRestore(doc, r);
      }
    }

    function selectTab(which){
      if (which === 'toc'){ $tabToc.setAttribute('aria-selected','true'); $tabBmk.setAttribute('aria-selected','false'); hide($bmkListWrap); show(QS('#cshell-toc-list')); }
      else { $tabToc.setAttribute('aria-selected','false'); $tabBmk.setAttribute('aria-selected','true'); hide(QS('#cshell-toc-list')); renderBookmarks(); show($bmkListWrap); }
    }
    $tabToc.addEventListener('click', ()=> selectTab('toc'));
    $tabBmk.addEventListener('click', ()=> selectTab('bmk'));

    async function initTOC(){
      CHAPTERS = await loadJSON('./chapters.json');
      $chapterList.innerHTML = '';
      for (let i=0;i<CHAPTERS.length;i++){
        const c = CHAPTERS[i];
        const li = document.createElement('li');
        li.className = 'cshell-item';
        li.innerHTML = `<a href="#read?i=${i}" data-i="${i}">${c.title.replace(/^第一编_/,'')}</a>`;
        $chapterList.appendChild(li);
      }
      updateResumeCard();
      QSA('a[data-i]', $chapterList).forEach(a => {
        a.addEventListener('click', (e)=>{ e.preventDefault(); const i = parseInt(a.getAttribute('data-i'),10); openChapter(i); history.pushState({read:i}, '', `#read?i=${i}`); });
      });
      $resumeBtn.addEventListener('click', ()=>{ const last2 = getLast(); if (last2 && CHAPTERS[last2.index]){ openChapter(last2.index, { restoreLast: true }); history.pushState({read:last2.index}, '', `#read?i=${last2.index}`); } });
    }

    function renderBookmarks(){
      const list = getBmk();
      $bmkItems.innerHTML = '';
      if (!list.length){ show($bmkEmpty); return; } else { hide($bmkEmpty); }
      list.forEach((bmk, idx) => {
        const li = document.createElement('li');
        li.className = 'cshell-bmk';
        const c = CHAPTERS[bmk.index] || {title:bmk.title || '未知章节', file:bmk.file || ''};
        li.innerHTML = `<div><div><strong>${c.title.replace(/^第一编_/,'')}</strong></div><div class="meta">${new Date(bmk.ts||Date.now()).toLocaleString()} · 进度 ${Math.round((bmk.scrollRatio||0)*100)}%</div></div><div class="act"><button data-act="go" data-i="${bmk.index}">打开</button><button data-act="del" data-k="${idx}">删除</button></div>`;
        $bmkItems.appendChild(li);
      });
      QSA('button[data-act="go"]', $bmkItems).forEach(btn => { btn.addEventListener('click', ()=> { const i = parseInt(btn.getAttribute('data-i'),10); openChapter(i, { restoreFromBookmark: true }); history.pushState({read:i}, '', `#read?i=${i}`); selectTab('toc'); }); });
      QSA('button[data-act="del"]', $bmkItems).forEach(btn => { btn.addEventListener('click', ()=> { const k = parseInt(btn.getAttribute('data-k'),10); const list2 = getBmk(); list2.splice(k,1); setBmk(list2); renderBookmarks(); toast('书签已删除'); }); });
    }

    function toTOC(){
      // snapshot before leaving
      snapshotProgress();
      if (scrollTimer){ clearInterval(scrollTimer); scrollTimer = null; }
      hide($reader); hide($nav); hide($bookmarkBtn);
      if ($progress) $progress.classList.add('hidden');
      updateResumeCard();
      show($toc);
    }

    function openChapter(i, opts={}){
      currentIndex = i;
      const ch = CHAPTERS[i]; if (!ch) return;
      hide($toc); show($reader); show($nav); show($bookmarkBtn);
      if ($progress) $progress.classList.remove('hidden');
      $prev.disabled = (i<=0); $next.disabled = (i>=CHAPTERS.length-1);
      setPageProgress(i);
      $frame.src = `./chapters/${encodeURIComponent(ch.file)}`;
      setLast({ index:i, file:ch.file, title:ch.title, scrollRatio:0 });
      $frame.onload = async ()=>{
        try {
          const doc = $frame.contentDocument;
          const style = doc.createElement('style'); style.textContent = `html,body{margin:0!important;padding:0!important;}`; doc.head.appendChild(style);
          const last = getLast();
          let targetRatio = 0;
          if (opts.restoreLast && last && last.index===i && typeof last.scrollRatio==='number'){ targetRatio = last.scrollRatio; }
          else if (opts.restoreFromBookmark){ const list = getBmk().filter(b=>b.index===i).sort((a,b)=>(b.ts||0)-(a.ts||0)); if (list[0]) targetRatio = list[0].scrollRatio || 0; }
          await segmentedRestore(doc, targetRatio);

          // live scroll update
          let tick = 0;
          doc.addEventListener('scroll', ()=>{ const now = Date.now(); if (now - tick < 80) return; tick = now; try{ const r = pxToRatio(doc); setScrollProgress(r); }catch(e){} }, { passive: true });

          // periodic save
          if (scrollTimer) clearInterval(scrollTimer);
          scrollTimer = setInterval(()=>{ try { const ratio = pxToRatio(doc); const cur = getLast() || {}; if (cur.index===i){ cur.scrollRatio = ratio; setLast(cur); setScrollProgress(ratio); } } catch(e){} }, 800);
        } catch(e){}
      };
    }

    $prev.addEventListener('click', ()=>{ if (currentIndex>0){ snapshotProgress(); openChapter(currentIndex-1); history.pushState({read:currentIndex-1}, '', `#read?i=${currentIndex-1}`); } });
    $next.addEventListener('click', ()=>{ if (currentIndex<CHAPTERS.length-1){ snapshotProgress(); openChapter(currentIndex+1); history.pushState({read:currentIndex+1}, '', `#read?i=${currentIndex+1}`); } });
    $tocBtn.addEventListener('click', ()=>{ toTOC(); history.pushState({toc:true}, '', '#toc'); });

    $bookmarkBtn.addEventListener('click', ()=>{
      try {
        const list = getBmk();
        const ch = CHAPTERS[currentIndex];
        let ratio = 0; try { const doc = $frame.contentDocument; ratio = pxToRatio(doc); } catch(e){ ratio = 0; }
        const exists = list.some(b => b.index===currentIndex && Math.abs((b.scrollRatio||0) - ratio) <= 0.01);
        if (exists){ toast('该位置已在书签中'); return; }
        list.unshift({ index: currentIndex, file: ch.file, title: ch.title, ts: Date.now(), scrollRatio: ratio });
        setBmk(list.slice(0,200));
        toast('已添加书签');
      } catch(e){ toast('无法添加书签'); }
    });

    window.addEventListener('popstate', ()=>{ const hash = location.hash || ''; if (hash.startsWith('#read')){ const params = new URLSearchParams(hash.split('?')[1] || ''); const i = parseInt(params.get('i') || '-1', 10); if (!isNaN(i) && i>=0){ openChapter(i, { restoreLast: true }); } } else { toTOC(); } });

    (async function boot(){
      await initTOC();
      if (location.hash.startsWith('#read')){ const params = new URLSearchParams(location.hash.split('?')[1] || ''); const i = parseInt(params.get('i') || '-1', 10); if (!isNaN(i) && i>=0){ openChapter(i, { restoreLast: true }); return; } }
      toTOC();
    })();

  })();
  </script>
</body>
</html>
